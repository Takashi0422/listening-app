<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‹±èªãƒªã‚¹ãƒ‹ãƒ³ã‚°æ•™æï¼ˆDifyé€£æº Ã— éŸ³å£°ä»˜ãï¼‰</title>
  <!-- ResponsiveVoice.js ã®ç„¡æ–™ç‰ˆ -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=free"></script>
</head>
<body>
  <h2>ğŸ§ è‹±èªãƒªã‚¹ãƒ‹ãƒ³ã‚°æ•™æ è‡ªå‹•ç”Ÿæˆ</h2>

  <label>ãƒ¬ãƒ™ãƒ«ï¼š</label><input type="text" id="level" value="ä¸­1"><br>
  <label>æ–‡æ³•å˜å…ƒï¼š</label><input type="text" id="grammar" value="beå‹•è©"><br>
  <label>ãƒ†ãƒ¼ãƒï¼š</label><input type="text" id="theme" value="å­¦æ ¡ç”Ÿæ´»"><br>
  <button onclick="generateLesson()">æ•™æã‚’ç”Ÿæˆï¼†èª­ã¿ä¸Šã’</button>

  <h3>ğŸ“œ è‹±æ–‡ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼š</h3>
  <pre id="english-script">ã“ã“ã«è‹±æ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</pre>
  <button onclick="playVoice()">â–¶ï¸ è‹±èªã‚’èª­ã¿ä¸Šã’ã‚‹</button>

  <script>
    const DIFY_API_KEY = "app-Vr8KPWzHvlILYGerF0cxdvrA";  // ã“ã“ã«Difyã®ã‚­ãƒ¼ã‚’è²¼ã‚‹
    const DIFY_API_URL = "https://api.dify.ai/v1/chat-messages";
    let scriptText = "";  // è‹±æ–‡ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿æŒ

    async function generateLesson() {
      const level = document.getElementById("level").value;
      const grammar = document.getElementById("grammar").value;
      const theme = document.getElementById("theme").value;

      const prompt = `
ãƒ¬ãƒ™ãƒ«: ${level}
æ–‡æ³•å˜å…ƒ: ${grammar}
ãƒ†ãƒ¼ãƒ: ${theme}
â†’ ä¸­å­¦ç”Ÿå‘ã‘è‹±èªæ•™æã‚’ä»¥ä¸‹ã®å½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ï¼š
1. è‹±æ–‡ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼š
2. æ—¥æœ¬èªè¨³ï¼š
3. ãƒªã‚¹ãƒ‹ãƒ³ã‚°å•é¡Œï¼š
4. è§£ç­”ï¼š
      `.trim();

      const res = await fetch(DIFY_API_URL, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${DIFY_API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          inputs: {},
          query: prompt
        })
      });

      const json = await res.json();
      const output = json.answer || json.output;

      // è‹±æ–‡ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æŠ½å‡º
      const match = output.match(/1\. è‹±æ–‡ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼š\n?([\s\S]*?)\n2\. æ—¥æœ¬èªè¨³/);
      scriptText = match ? match[1].trim() : "ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ";
      document.getElementById("english-script").innerText = scriptText;
      playVoice(); // è‡ªå‹•ã§èª­ã¿ä¸Šã’
    }

    function playVoice() {
      if (!scriptText) {
        alert("ã¾ãšã¯æ•™æã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼");
        return;
      }
      responsiveVoice.speak(scriptText, "UK English Female");
    }
  </script>
</body>
</html>
